import { NextRequest,NextResponse } from 'next/server';import path from 'path';import fs from 'fs/promises';
export const runtime='nodejs';
export async function POST(req:NextRequest){const isAdmin=req.cookies.get('admin')?.value==='1';if(!isAdmin)return NextResponse.json({error:'Unauthorized'},{status:401});const data=await req.formData();const productId=String(data.get('productId')||'');const file=data.get('file') as File|null;if(!productId||!file)return NextResponse.json({error:'Missing fields'},{status:400});const allowed=['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','text/plain'];if(!allowed.includes(file.type))return NextResponse.json({error:'Unsupported file type'},{status:400});const buffer=Buffer.from(await file.arrayBuffer());const uploadDir=path.join(process.cwd(),'public','uploads',productId);await fs.mkdir(uploadDir,{recursive:true});const ext=path.extname(file.name)||'.pdf';const fileName=`${Date.now()}${ext}`;await fs.writeFile(path.join(uploadDir,fileName),buffer);return NextResponse.json({ok:true,url:`/uploads/${productId}/${fileName}`});}
